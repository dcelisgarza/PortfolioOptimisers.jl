function set_risk_constraints!(model::JuMP.Model, i::Any, r::ConditionalValueatRisk,
                               opt::RiskJuMPOptimisationEstimator, pr::AbstractPriorResult,
                               args...; kwargs...)
    key = Symbol(:cvar_risk_, i)
    sc = model[:sc]
    net_X = set_net_portfolio_returns!(model, pr.X)
    T = length(net_X)
    var, z_cvar = model[Symbol(:var_, i)], model[Symbol(:z_cvar_, i)] = @variables(model,
                                                                                   begin
                                                                                       ()
                                                                                       [1:T],
                                                                                       (lower_bound = 0)
                                                                                   end)
    wi = nothing_scalar_array_factory(r.w, pr.w)
    cvar_risk = model[key] = if isnothing(wi)
        iat = inv(r.alpha * T)
        @expression(model, var + sum(z_cvar) * iat)
    else
        iat = inv(r.alpha * sum(wi))
        @expression(model, var + dot(wi, z_cvar) * iat)
    end
    model[Symbol(:ccvar_, i)] = @constraint(model, sc * ((z_cvar + net_X) .+ var) >= 0)
    set_risk_bounds_and_expression!(model, opt, cvar_risk, r.settings, key)
    return cvar_risk
end
function set_risk_constraints!(model::JuMP.Model, i::Any, r::ConditionalValueatRiskRange,
                               opt::RiskJuMPOptimisationEstimator, pr::AbstractPriorResult,
                               args...; kwargs...)
    key = Symbol(:cvar_range_risk_, i)
    sc = model[:sc]
    net_X = set_net_portfolio_returns!(model, pr.X)
    T = length(net_X)
    var_l, z_cvar_l, var_h, z_cvar_h = model[Symbol(:var_l_, i)], model[Symbol(:z_cvar_l_, i)], model[Symbol(:var_h_, i)], model[Symbol(:z_cvar_h_, i)] = @variables(model,
                                                                                                                                                                     begin
                                                                                                                                                                         ()
                                                                                                                                                                         [1:T],
                                                                                                                                                                         (lower_bound = 0)
                                                                                                                                                                         ()
                                                                                                                                                                         [1:T],
                                                                                                                                                                         (upper_bound = 0)
                                                                                                                                                                     end)
    wi = nothing_scalar_array_factory(r.w, pr.w)
    cvar_risk_l, cvar_risk_h = if isnothing(wi)
        iat = inv(r.alpha * T)
        ibt = inv(r.beta * T)
        model[Symbol(:cvar_risk_l_, i)], model[Symbol(:cvar_risk_h_, i)] = @expressions(model,
                                                                                        begin
                                                                                            var_l +
                                                                                            sum(z_cvar_l) *
                                                                                            iat
                                                                                            var_h +
                                                                                            sum(z_cvar_h) *
                                                                                            ibt
                                                                                        end)
    else
        sw = sum(wi)
        iat = inv(r.alpha * sw)
        ibt = inv(r.beta * sw)
        model[Symbol(:cvar_risk_l_, i)], model[Symbol(:cvar_risk_h_, i)] = @expressions(model,
                                                                                        begin
                                                                                            var_l +
                                                                                            dot(wi,
                                                                                                z_cvar_l) *
                                                                                            iat
                                                                                            var_h +
                                                                                            dot(wi,
                                                                                                z_cvar_h) *
                                                                                            ibt
                                                                                        end)
    end
    cvar_range_risk = model[key] = @expression(model, cvar_risk_l - cvar_risk_h)
    model[Symbol(:ccvar_l_, i)], model[Symbol(:ccvar_h_, i)] = @constraints(model,
                                                                            begin
                                                                                sc *
                                                                                ((z_cvar_l +
                                                                                  net_X) .+
                                                                                 var_l) >=
                                                                                0
                                                                                sc *
                                                                                ((z_cvar_h +
                                                                                  net_X) .+
                                                                                 var_h) <=
                                                                                0
                                                                            end)
    set_risk_bounds_and_expression!(model, opt, cvar_range_risk, r.settings, key)
    return cvar_range_risk
end
function set_risk_constraints!(model::JuMP.Model, i::Any,
                               r::DistributionallyRobustConditionalValueatRisk,
                               opt::RiskJuMPOptimisationEstimator, pr::AbstractPriorResult,
                               args...; kwargs...)
    key = Symbol(:drcvar_risk_, i)
    sc = model[:sc]
    w = model[:w]
    net_X = set_net_portfolio_returns!(model, pr.X)
    Xap1 = set_portfolio_returns_plus_one!(model, pr.X)
    T, N = size(pr.X)

    alpha = r.alpha
    b1 = r.l
    radius = r.r

    a1 = -one(alpha)
    a2 = -one(alpha) - b1 * inv(alpha)
    b2 = b1 * (one(alpha) - inv(alpha))
    lb, tau, s, tu_drcvar, tv_drcvar, u, v = model[Symbol(:lb_, i)], model[Symbol(:tau_, i)], model[Symbol(:s_, i)], model[Symbol(:tu_drcvar_, i)], model[Symbol(:tv_drcvar_, i)], model[Symbol(:u_, i)], model[Symbol(:v_, i)] = @variables(model,
                                                                                                                                                                                                                                             begin
                                                                                                                                                                                                                                                 ()
                                                                                                                                                                                                                                                 ()
                                                                                                                                                                                                                                                 [1:T]
                                                                                                                                                                                                                                                 [1:T]
                                                                                                                                                                                                                                                 [1:T]
                                                                                                                                                                                                                                                 [1:T,
                                                                                                                                                                                                                                                  1:N],
                                                                                                                                                                                                                                                 (lower_bound = 0)
                                                                                                                                                                                                                                                 [1:T,
                                                                                                                                                                                                                                                  1:N],
                                                                                                                                                                                                                                                 (lower_bound = 0)
                                                                                                                                                                                                                                             end)
    model[Symbol(:cu_drcvar_, i)], model[Symbol(:cv_drcvar_, i)], model[Symbol(:cu_drcvar_infnorm_, i)], model[Symbol(:cv_drcvar_infnorm_, i)], model[Symbol(:cu_drcvar_lb_, i)], model[Symbol(:cv_drcvar_lb_, i)] = @constraints(model,
                                                                                                                                                                                                                                  begin
                                                                                                                                                                                                                                      sc *
                                                                                                                                                                                                                                      (b1 *
                                                                                                                                                                                                                                       tau .+
                                                                                                                                                                                                                                       (a1 *
                                                                                                                                                                                                                                        net_X +
                                                                                                                                                                                                                                        vec(sum(u .*
                                                                                                                                                                                                                                                Xap1;
                                                                                                                                                                                                                                                dims = 2)) -
                                                                                                                                                                                                                                        s)) <=
                                                                                                                                                                                                                                      0
                                                                                                                                                                                                                                      sc *
                                                                                                                                                                                                                                      (b2 *
                                                                                                                                                                                                                                       tau .+
                                                                                                                                                                                                                                       (a2 *
                                                                                                                                                                                                                                        net_X +
                                                                                                                                                                                                                                        vec(sum(v .*
                                                                                                                                                                                                                                                Xap1;
                                                                                                                                                                                                                                                dims = 2)) -
                                                                                                                                                                                                                                        s)) <=
                                                                                                                                                                                                                                      0
                                                                                                                                                                                                                                      [i = 1:T],
                                                                                                                                                                                                                                      [sc *
                                                                                                                                                                                                                                       tu_drcvar[i]
                                                                                                                                                                                                                                       sc *
                                                                                                                                                                                                                                       (-view(u,
                                                                                                                                                                                                                                              i,
                                                                                                                                                                                                                                              :) -
                                                                                                                                                                                                                                        a1 *
                                                                                                                                                                                                                                        w)] in
                                                                                                                                                                                                                                      MOI.NormInfinityCone(1 +
                                                                                                                                                                                                                                                           N)
                                                                                                                                                                                                                                      [i = 1:T],
                                                                                                                                                                                                                                      [sc *
                                                                                                                                                                                                                                       tv_drcvar[i]
                                                                                                                                                                                                                                       sc *
                                                                                                                                                                                                                                       (-view(v,
                                                                                                                                                                                                                                              i,
                                                                                                                                                                                                                                              :) -
                                                                                                                                                                                                                                        a2 *
                                                                                                                                                                                                                                        w)] in
                                                                                                                                                                                                                                      MOI.NormInfinityCone(1 +
                                                                                                                                                                                                                                                           N)
                                                                                                                                                                                                                                      sc *
                                                                                                                                                                                                                                      (tu_drcvar .-
                                                                                                                                                                                                                                       lb) <=
                                                                                                                                                                                                                                      0
                                                                                                                                                                                                                                      sc *
                                                                                                                                                                                                                                      (tv_drcvar .-
                                                                                                                                                                                                                                       lb) <=
                                                                                                                                                                                                                                      0
                                                                                                                                                                                                                                  end)
    wi = nothing_scalar_array_factory(r.w, pr.w)
    drcvar_risk = model[key] = if isnothing(wi)
        @expression(model, radius * lb + mean(s))
    else
        @expression(model, radius * lb + mean(s, wi))
    end
    set_risk_bounds_and_expression!(model, opt, drcvar_risk, r.settings, key)
    return drcvar_risk
end
function set_risk_constraints!(model::JuMP.Model, i::Any,
                               r::DistributionallyRobustConditionalValueatRiskRange,
                               opt::RiskJuMPOptimisationEstimator, pr::AbstractPriorResult,
                               args...; kwargs...)
    key = Symbol(:drcvar_risk_range_, i)
    sc = model[:sc]
    w = model[:w]
    net_X = set_net_portfolio_returns!(model, pr.X)
    Xap1 = set_portfolio_returns_plus_one!(model, pr.X)
    T, N = size(pr.X)

    alpha = r.alpha
    b1_l = r.l_a
    radius_l = r.r_a

    beta = r.beta
    b1_h = r.l_b
    radius_h = r.r_b

    a1_l = -one(alpha)
    a2_l = -one(alpha) - b1_l * inv(alpha)
    b2_l = b1_l * (one(alpha) - inv(alpha))

    a1_h = -one(beta)
    a2_h = -one(beta) - b1_h * inv(beta)
    b2_h = b1_h * (one(beta) - inv(beta))
    lb_l, tau_l, s_l, tu_drcvar_l, tv_drcvar_l, u_l, v_l, lb_h, tau_h, s_h, tu_drcvar_h, tv_drcvar_h, u_h, v_h = model[Symbol(:lb_l_, i)], model[Symbol(:tau_l_, i)], model[Symbol(:s_l_, i)], model[Symbol(:tu_drcvar_l_, i)], model[Symbol(:tv_drcvar_l_, i)], model[Symbol(:u_l_, i)], model[Symbol(:v_l_, i)], model[Symbol(:lb_h_, i)], model[Symbol(:tau_h_, i)], model[Symbol(:s_h_, i)], model[Symbol(:tu_drcvar_h_, i)], model[Symbol(:tv_drcvar_h_, i)], model[Symbol(:u_h_, i)], model[Symbol(:v_h_, i)] = @variables(model,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 begin
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      1:N],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (lower_bound = 0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      1:N],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (lower_bound = 0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      1:N],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (upper_bound = 0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     [1:T,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      1:N],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     (upper_bound = 0)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 end)
    model[Symbol(:cu_drcvar_l_, i)], model[Symbol(:cv_drcvar_l_, i)], model[Symbol(:cu_drcvar_infnorm_l_, i)], model[Symbol(:cv_drcvar_infnorm_l_, i)], model[Symbol(:cu_drcvar_lb_l_, i)], model[Symbol(:cv_drcvar_lb_l_, i)], model[Symbol(:cu_drcvar_h_, i)], model[Symbol(:cv_drcvar_h_, i)], model[Symbol(:cu_drcvar_infnorm_h_, i)], model[Symbol(:cv_drcvar_infnorm_h_, i)], model[Symbol(:cu_drcvar_lb_h_, i)], model[Symbol(:cv_drcvar_lb_h_, i)] = @constraints(model,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          begin
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (b1_l *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               tau_l .+
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (a1_l *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                net_X +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                vec(sum(u_l .*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Xap1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dims = 2)) -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                s_l)) <=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (b2_l *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               tau_l .+
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (a2_l *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                net_X +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                vec(sum(v_l .*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Xap1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dims = 2)) -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                s_l)) <=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              [i = 1:T],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              [sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               tu_drcvar_l[i]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (-view(u_l,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      i,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      :) -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                a1_l *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                w)] in
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              MOI.NormInfinityCone(1 +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   N)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              [i = 1:T],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              [sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               tv_drcvar_l[i]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (-view(v_l,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      i,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      :) -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                a2_l *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                w)] in
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              MOI.NormInfinityCone(1 +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   N)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (tu_drcvar_l .-
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               lb_l) <=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (tv_drcvar_l .-
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               lb_l) <=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (b1_h *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               tau_h .+
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (a1_h *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                net_X +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                vec(sum(u_h .*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Xap1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dims = 2)) -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                s_h)) >=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (b2_h *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               tau_h .+
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (a2_h *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                net_X +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                vec(sum(v_h .*
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        Xap1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dims = 2)) -
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                s_h)) >=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              [i = 1:T],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              [-sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               tu_drcvar_h[i]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (view(u_h,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     i,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     :) +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                a1_h *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                w)] in
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              MOI.NormInfinityCone(1 +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   N)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              [i = 1:T],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              [-sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               tv_drcvar_h[i]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               (view(v_h,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     i,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     :) +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                a2_h *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                w)] in
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              MOI.NormInfinityCone(1 +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   N)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (tu_drcvar_h .-
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               lb_h) >=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              sc *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (tv_drcvar_h .-
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               lb_h) >=
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          end)
    wi = nothing_scalar_array_factory(r.w, pr.w)
    drcvar_risk_l, drcvar_risk_h = model[Symbol(:drcvar_risk_l_, i)], model[Symbol(:drcvar_risk_h_, i)] = if isnothing(wi)
        @expressions(model, begin
                         radius_l * lb_l + mean(s_l)
                         radius_h * lb_h + mean(s_h)
                     end)
    else
        @expressions(model, begin
                         radius_l * lb_l + mean(s_l, wi)
                         radius_h * lb_h + mean(s_h, wi)
                     end)
    end
    drcvar_risk_range = model[key] = @expression(model, drcvar_risk_l - drcvar_risk_h)
    set_risk_bounds_and_expression!(model, opt, drcvar_risk_range, r.settings, key)
    return drcvar_risk_range
end
function set_risk_constraints!(model::JuMP.Model, i::Any, r::ConditionalDrawdownatRisk,
                               opt::RiskJuMPOptimisationEstimator, pr::AbstractPriorResult,
                               args...; kwargs...)
    key = Symbol(:cdar_risk_, i)
    sc = model[:sc]
    dd = set_drawdown_constraints!(model, pr.X)
    T = length(dd) - 1
    iat = inv(r.alpha * T)
    dar, z_cdar = model[Symbol(:dar_, i)], model[Symbol(:z_cdar_, i)] = @variables(model,
                                                                                   begin
                                                                                       ()
                                                                                       [1:T],
                                                                                       (lower_bound = 0)
                                                                                   end)
    cdar_risk = model[key] = @expression(model, dar + sum(z_cdar) * iat)
    model[Symbol(:ccdar_, i)] = @constraint(model,
                                            sc * ((z_cdar - view(dd, 2:(T + 1))) .+ dar) >=
                                            0)
    set_risk_bounds_and_expression!(model, opt, cdar_risk, r.settings, key)
    return cdar_risk
end
